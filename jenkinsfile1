pipeline {
      agent {
            dockerfile {
                filename 'Dockerfile'
                dir 'cicd/docker'
                label 'Docker-enabled'
            }
        }
     environment {
        sfcc_ClientId  = credentials('CLIENT_ID')
        sfcc_Client_Secret  = credentials('CLIENT_SECRET')
	dev_env = "bgtm-024.sandbox.us01.dx.commercecloud.salesforce.com"
       }
    stages {
       stage('BUILD') {
	        steps {
                    dir('sfra-webpack-builder/') {
                        sh('npm install')
			sh('npm run npm Install')
			sh('npm run dev')	  
           	    }
		 }
             }
      stage('Authorize DevHub') {
             steps{
	       script {
		  rc = command 'sfcc-ci client:auth ${sfcc_ClientId} ${sfcc_Client_Secret}'
		  if (rc != 0) {
                   error 'Salesforce dev hub org authorization failed.'
                     }
		}  
	    }	
        }
      stage('Deploys CodeVersion') {
          steps{
		script {
			echo "#####Initiating Deployment to Commerce Cloud instance#####"
			rc = command 'sfcc-ci code:deploy <path/to/code_version.zip> -i bgtm-024.sandbox.us01.dx.commercecloud.salesforce.com'
		        if (rc != 0) {
                           error 'Commerce Cloud instance deployment failed.'
                     	}
			echo "################SUCCESSFULLY DEPLOYED################"
		  }
              }	   
	  }	
 /*    stage('Activate CodeVersion') {
           steps{
		script {
			echo "#####ACTIVATE CODEVERSION#####"
			rc = command 'sfcc-ci code:activate <code_version> -i your-instance.demandware.net'
		        if (rc != 0) {
                           error 'CodeVersion Activation Failed.'
                     	}
			echo "######SUCCESSFULLY ACTIVATED#####"
		  }
       		 }	   
	  } 
       stage('Data Upload') {
          steps{
		script {
			echo "#####Initiating Data Upload#####"
			rc = command 'sfcc-ci instance:upload <path/to/data.zip> -i your-instance.demandware.net'
		        if (rc != 0) {
                           error 'Data Upload failed.'
                     	}
			echo "######SUCCESSFULLY DATA UPLOADED#####"
		  }
             }	   
	  }	
      stage('Data Import') {
          steps{
		script {
			echo "#####Initiating Data Import#####"
			rc = command 'sfcc-ci instance:import <data.zip> -i your-instance.demandware.net -s'
		        if (rc != 0) {
                           error 'Data Import failed.'
                     	}
			echo "######SUCCESSFULLY DATA IMPORTED#####"
		  }
      	      }	   
	  } */  	  
    }
}
def command(script) {
    if (isUnix()) {
        return sh(returnStatus: true, script: script);
    } else {
        return bat(returnStatus: true, script: script);
    }	 
}

